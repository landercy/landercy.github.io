# ZOOKEEPER
ZooKeeper 是一个典型的分布式数据一致性解决方案，分布式应用程序可以基于 ZooKeeper 实现诸如数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master 选举、分布式锁和分布式队列等功能。

ZooKeeper 一个最常用的使用场景就是用于担任服务生产者和服务消费者的注册中心。

雅虎的开发人员就试图开发一个通用的无单点问题的分布式协调框架，以便让开发人员将精力集中在处理业务逻辑上。

## 分布式单点故障
通常分布式系统采用主从模式，就是一个主控机连接多个处理节点。主节点负责分发任务，从节点负责处理任务，当我们的主节点发生故障时，那么整个系统就都瘫痪了，那么我们把这种故障叫作单点故障。

### 无状态服务单点问题

- 容易进行平行扩展
- 增加一个代理节点，专门做消息的转发，其他业务直接与代理节点通信，从而降低各进程通信的网络结构复杂度，类似星型网络结构
- 为保障可用性，可增加一个代理节点。业务进程需要与两个代理节点之间增加一个心跳机制，业务进程发送消息时需要选择可用的代理节点。
- 消息顺序问题：对于对消息顺序有要求的业务，指定固定的代理节点。

### 有状态的服务单点问题

- 优先考虑去除状态，将问题退化为无状态服务单点问题
- 对于部分业务，只能在一个节点内处理，在多节点中处理会造成状态不一致，这些业务无法去除状态。
- 主备方案(Master-Slave)：
  - 新增slave节点，默认消息发往master节点。
  - 主备节点之间采用ping方式通信。
    - slave定时发送ping包给master
    - master收到后响应Ack包
  - 当slave发现master没有响应时，即视为master已挂，然后把自己升为master，并通知业务进程把消息转发给自己。
  - 问题：当网络出现问题时，slave会认为master挂了，自己升级为master，而实际上master还在运行。这时，两个master会同时处理一份数据，造成数据混乱。此时需要裁决，哪个节点是master
    - 方案一：引入第三方服务
    - 方案二：通过选举算法和租约的方式实现master的选举

#### 方案一：引入ZooKeeper调度
- 启动两个主节点，向ZooKeeper注册
- 注册后选举，编号小的为真正主节点

#### 方案二：使用选举算法和租约
- 选举算法：Paxos, Raft
- 选举框架：PhxPaxos(微信)
- 通过选举算法确定一个master
- 引入租约机制，确保任何时候只有一个master
  - 一个节点成为master后，所有节点开始计时
  - 超过租约时间后，所有节点发起选举请求，进行重新选举
  - 为避免频繁切换master
    - master要提前发起选举请求续租，其他节点应答
    - 租约到期前，非master节点不可发起选举请求